<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="835px" preserveAspectRatio="none" style="width:2586px;height:835px;" version="1.1" viewBox="0 0 2586 835" width="2586px" zoomAndPan="magnify"><defs><filter height="300%" id="f2mikwrx0mnmv" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="21.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="99" y="52.2969"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="219.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="357" y="73.4297"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="480.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="293.3594"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1326" y="322.4922"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="82.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1470" y="380.7578"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="87.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1695.5" y="576.5547"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="59.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2094.5" y="693.0859"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2429.5" y="722.2188"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="601.5234" style="stroke: #000000; stroke-width: 2.0;" width="2358.5" x="217" y="172.6953"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="512.125" style="stroke: #000000; stroke-width: 2.0;" width="2338.5" x="227" y="255.0938"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="364.4609" style="stroke: #000000; stroke-width: 2.0;" width="1642.5" x="913" y="395.7578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="104" x2="104" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="362" x2="362" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="733" x2="733" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1037" x2="1037" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1330.5" x2="1330.5" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1474.5" x2="1474.5" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1700.5" x2="1700.5" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1964.5" x2="1964.5" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2099.5" x2="2099.5" y1="42.2969" y2="791.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2434.5" x2="2434.5" y1="42.2969" y2="791.2188"/><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="188" x="8" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="174" x="15" y="26.9951">ConsumerWorker.Worker</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="188" x="8" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="174" x="15" y="810.2139">ConsumerWorker.Worker</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="246" x="237" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="232" x="244" y="26.9951">KafkaMessageConsumerManager</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="246" x="237" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="232" x="244" y="810.2139">KafkaMessageConsumerManager</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="356" x="553" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="342" x="560" y="26.9951">KafkaMessageConsumerManager.ServiceProvider</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="356" x="553" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="342" x="560" y="810.2139">KafkaMessageConsumerManager.ServiceProvider</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="224" x="923" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="210" x="930" y="26.9951">KafkaTopicMessageConsumer</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="224" x="923" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="210" x="930" y="810.2139">KafkaTopicMessageConsumer</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="1243.5" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="1250.5" y="26.9951">KafkaConsumerBuilder</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="1243.5" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="1250.5" y="810.2139">KafkaConsumerBuilder</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="1428.5" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="1435.5" y="26.9951">IConsumer</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="1428.5" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="1435.5" y="810.2139">IConsumer</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="334" x="1531.5" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="320" x="1538.5" y="26.9951">KafkaTopicMessageConsumer.ServiceProvider</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="334" x="1531.5" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="320" x="1538.5" y="810.2139">KafkaTopicMessageConsumer.ServiceProvider</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="167" x="1879.5" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="153" x="1886.5" y="26.9951">scope.ServiceProvider</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="167" x="1879.5" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="153" x="1886.5" y="810.2139">scope.ServiceProvider</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="2060.5" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="2067.5" y="26.9951">Mediator</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="2060.5" y="790.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="2067.5" y="810.2139">Mediator</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="214" x="2327.5" y="3"/><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="214" x="2323.5" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="200" x="2330.5" y="26.9951">MessageNotificationHandlers</text><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="214" x="2327.5" y="790.2188"/><rect fill="#FEFECE" filter="url(#f2mikwrx0mnmv)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="214" x="2323.5" y="794.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="200" x="2330.5" y="814.2139">MessageNotificationHandlers</text><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="21.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="99" y="52.2969"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="219.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="357" y="73.4297"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="480.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="293.3594"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1326" y="322.4922"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="82.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1470" y="380.7578"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="87.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1695.5" y="576.5547"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="59.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2094.5" y="693.0859"/><rect fill="#FFFFFF" filter="url(#f2mikwrx0mnmv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2429.5" y="722.2188"/><polygon fill="#A80036" points="345,69.4297,355,73.4297,345,77.4297,349,73.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="351" y1="73.4297" y2="73.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="111" y="68.3638">StartConsumers(cancellationToken)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="409" y1="102.5625" y2="102.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="409" x2="409" y1="102.5625" y2="115.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="368" x2="409" y1="115.5625" y2="115.5625"/><polygon fill="#A80036" points="378,111.5625,368,115.5625,378,119.5625,374,115.5625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="374" y="97.4966">find all messages with notification handlers</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="409" y1="144.6953" y2="144.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="409" x2="409" y1="144.6953" y2="157.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="368" x2="409" y1="157.6953" y2="157.6953"/><polygon fill="#A80036" points="378,153.6953,368,157.6953,378,161.6953,374,157.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="374" y="139.6294">find the topics for those messages</text><path d="M217,172.6953 L294,172.6953 L294,179.6953 L284,189.6953 L217,189.6953 L217,172.6953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="601.5234" style="stroke: #000000; stroke-width: 2.0;" width="2358.5" x="217" y="172.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="232" y="185.7622">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="309" y="184.9058">[each topic with notification handlers]</text><polygon fill="#A80036" points="721,206.9609,731,210.9609,721,214.9609,725,210.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="727" y1="210.9609" y2="210.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="342" x="374" y="205.895">GetRequiredService&lt;IKafkaTopicMessageConsumer&gt;</text><polygon fill="#A80036" points="378,236.0938,368,240.0938,378,244.0938,374,240.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="372" x2="732" y1="240.0938" y2="240.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="384" y="235.0278">kafkaTopicMessageConsumer</text><path d="M227,255.0938 L356,255.0938 L356,262.0938 L346,272.0938 L227,272.0938 L227,255.0938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="512.125" style="stroke: #000000; stroke-width: 2.0;" width="2338.5" x="227" y="255.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="242" y="268.1606">new thread</text><polygon fill="#A80036" points="1020,289.3594,1030,293.3594,1020,297.3594,1024,293.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="1026" y1="293.3594" y2="293.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="369" y="288.2935">StartConsuming(topic, cancellationToken)</text><polygon fill="#A80036" points="1314,318.4922,1324,322.4922,1314,326.4922,1318,322.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="1320" y1="322.4922" y2="322.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="1049" y="317.4263">build()</text><polygon fill="#A80036" points="1053,347.625,1043,351.625,1053,355.625,1049,351.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1047" x2="1330" y1="351.625" y2="351.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1059" y="346.5591">consumer</text><polygon fill="#A80036" points="1458,376.7578,1468,380.7578,1458,384.7578,1462,380.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="1464" y1="380.7578" y2="380.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="1049" y="375.6919">subscribe(topic)</text><path d="M913,395.7578 L990,395.7578 L990,402.7578 L980,412.7578 L913,412.7578 L913,395.7578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="364.4609" style="stroke: #000000; stroke-width: 2.0;" width="1642.5" x="913" y="395.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="928" y="408.8247">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="1005" y="407.9683">[while no cancellation requested on cancellationToken]</text><polygon fill="#A80036" points="1458,430.0234,1468,434.0234,1458,438.0234,1462,434.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="1464" y1="434.0234" y2="434.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1049" y="428.9575">consume(cancellationToken)</text><polygon fill="#A80036" points="1053,459.1563,1043,463.1563,1053,467.1563,1049,463.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1047" x2="1474" y1="463.1563" y2="463.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="1059" y="458.0903">consumeResult</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="1084" y1="492.2891" y2="492.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1084" x2="1084" y1="492.2891" y2="505.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1043" x2="1084" y1="505.2891" y2="505.2891"/><polygon fill="#A80036" points="1053,501.2891,1043,505.2891,1053,509.2891,1049,505.2891" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1049" y="487.2231">determine message type</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="1084" y1="534.4219" y2="534.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1084" x2="1084" y1="534.4219" y2="547.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1043" x2="1084" y1="547.4219" y2="547.4219"/><polygon fill="#A80036" points="1053,543.4219,1043,547.4219,1053,551.4219,1049,547.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="1049" y="529.356">use reflection to build MessageNotification</text><polygon fill="#A80036" points="1683.5,572.5547,1693.5,576.5547,1683.5,580.5547,1687.5,576.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="1689.5" y1="576.5547" y2="576.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1049" y="571.4888">CreateScope()</text><polygon fill="#A80036" points="1053,601.6875,1043,605.6875,1053,609.6875,1049,605.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1047" x2="1694.5" y1="605.6875" y2="605.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1059" y="600.6216">scope</text><polygon fill="#A80036" points="1953,630.8203,1963,634.8203,1953,638.8203,1957,634.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="1959" y1="634.8203" y2="634.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="1049" y="629.7544">GetRequiredService&lt;IMediator&gt;</text><polygon fill="#A80036" points="1053,659.9531,1043,663.9531,1053,667.9531,1049,663.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1047" x2="1964" y1="663.9531" y2="663.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="1059" y="658.8872">mediator</text><polygon fill="#A80036" points="2082.5,689.0859,2092.5,693.0859,2082.5,697.0859,2086.5,693.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1042" x2="2088.5" y1="693.0859" y2="693.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="1049" y="688.02">send(messageNotification, cancellationToken)</text><polygon fill="#A80036" points="2417.5,718.2188,2427.5,722.2188,2417.5,726.2188,2421.5,722.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2104.5" x2="2423.5" y1="722.2188" y2="722.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="2111.5" y="717.1528">handle(messageNotification, cancellationToken)</text><!--MD5=[d6bf9a41d44bdb520fd604cfe8dc3d04]
@startuml
    participant ConsumerWorker.Worker
    participant KafkaMessageConsumerManager
    participant KafkaMessageConsumerManager.ServiceProvider
    participant KafkaTopicMessageConsumer
    participant KafkaConsumerBuilder
    participant IConsumer
    participant KafkaTopicMessageConsumer.ServiceProvider
    participant scope.ServiceProvider
    participant Mediator
    collections MessageNotificationHandlers

    activate ConsumerWorker.Worker
    ConsumerWorker.Worker -> KafkaMessageConsumerManager : StartConsumers(cancellationToken)
    deactivate ConsumerWorker.Worker

    activate KafkaMessageConsumerManager
    KafkaMessageConsumerManager -> KafkaMessageConsumerManager : find all messages with notification handlers
    KafkaMessageConsumerManager -> KafkaMessageConsumerManager : find the topics for those messages
    loop each topic with notification handlers
        KafkaMessageConsumerManager -> KafkaMessageConsumerManager.ServiceProvider : GetRequiredService<IKafkaTopicMessageConsumer>
        KafkaMessageConsumerManager <- - KafkaMessageConsumerManager.ServiceProvider : kafkaTopicMessageConsumer
        group new thread
            KafkaMessageConsumerManager -> KafkaTopicMessageConsumer : StartConsuming(topic, cancellationToken)
            deactivate KafkaMessageConsumerManager

            activate KafkaTopicMessageConsumer
            KafkaTopicMessageConsumer -> KafkaConsumerBuilder : build()

            activate KafkaConsumerBuilder
            KafkaTopicMessageConsumer <- - KafkaConsumerBuilder : consumer
            deactivate KafkaConsumerBuilder

            KafkaTopicMessageConsumer -> IConsumer : subscribe(topic)
            activate IConsumer
            loop while no cancellation requested on cancellationToken
                KafkaTopicMessageConsumer -> IConsumer : consume(cancellationToken)
                KafkaTopicMessageConsumer <- - IConsumer : consumeResult
                deactivate IConsumer

                KafkaTopicMessageConsumer -> KafkaTopicMessageConsumer : determine message type
                KafkaTopicMessageConsumer -> KafkaTopicMessageConsumer : use reflection to build MessageNotification

                KafkaTopicMessageConsumer -> KafkaTopicMessageConsumer.ServiceProvider : CreateScope()
                activate KafkaTopicMessageConsumer.ServiceProvider
                KafkaTopicMessageConsumer <- - KafkaTopicMessageConsumer.ServiceProvider : scope
                KafkaTopicMessageConsumer -> scope.ServiceProvider : GetRequiredService<IMediator>
                KafkaTopicMessageConsumer <- - scope.ServiceProvider : mediator
                deactivate KafkaTopicMessageConsumer.ServiceProvider

                KafkaTopicMessageConsumer -> Mediator : send(messageNotification, cancellationToken)
                activate Mediator
                Mediator -> MessageNotificationHandlers : handle(messageNotification, cancellationToken)
                activate MessageNotificationHandlers
                deactivate MessageNotificationHandlers
                deactivate Mediator
            end
        end
        deactivate KafkaTopicMessageConsumer
    end
@enduml

PlantUML version 1.2020.06(Sun Apr 05 12:38:32 GMT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 14-ea+33
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>